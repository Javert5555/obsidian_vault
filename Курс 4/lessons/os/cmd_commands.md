## Использование параметров командной строки

Для доступа из командного файла к параметрам командной строки применяются символы %0, %1, …, %9 или %*. При этом вместо %0 подставляется имя выполняемого пакетного файла, вместо %1, %2, …, %9 — значения первых девяти параметров командной строки соответственно, а вместо %* — все аргументы.

Пусть имеется командный файл copier.bat следующего содержания:
``` cmd
@ECHO OFF CLS
ECHO Файл %0 копирует каталог %1 в %2
XCOPY %1 %2 /S
```

Если запустить его из командной строки с двумя параметрами, например: `copier.bat C:\Programs D:\Backup`, то на экран выведется сообщение: "Файл copier.bat копирует каталог C:\Programs в D:\Backup" и произойдет копирование каталога C:\Programs со всеми его подкаталогами в D:\Backup.

## Получение значения переменной

Команда **SET** используется для просмотра и изменения переменных среды окружения в командной строке Windows. Переменные окружения - это переменные, принимаемые значения которых характеризуют среду, в которой выполняется текущая программа - пути системных файлов, сведения об аппаратных средствах, каталоги пользователя и т.п.

**SET переменная**  
**`SET PATH`** - отобразить значение переменной **PATH**  
Для создания новой переменной, или изменения значения существующей, используется команда :  
  
**`SET` переменная=строка**  
  
**переменная** - Имя переменной среды.  
**строка** - Строка символов, присваиваемая указанной переменной.  
  
**`SET MyName=Vasya`** - установить значение переменной **MyName**  
  
**`SET path=C:\progs;%path%`** - изменить значение переменной **PATH**, добавив в начало строки **C:\progs**  
  
Значение, принимаемое переменной , доступно для обработки в командных файлах, при использовании ее имени, заключенного в знаки процента - **%** . Например команда выдачи текста на дисплей ECHO в виде:  
  
**`ECHO date`** - выведет на экран слово "date", а команда  
**`ECHO %date%`** выведет на экран значение переменной **date**, т.е. текущую дату в формате операционной системы.  
  
Команда **SET** без параметров используется для вывода текущих значений переменных среды.

## Операции с переменными как с числами
Для того чтобы была **возможность рассматривать значения переменных среды как числа** и производить с ними арифметические вычисления (используются ТОЛЬКО целые числа) используется команда SET с ключом /A.

`@ECHO OFF`
`SET /A M=%1+%2`:: В переменной M будет храниться сумма
`ECHO Сумма %1 и %2 равна %M%`
`M SET M=`:: Удалим переменную

В команде SET с ключом /A могут использоваться операции – (вычитание), * (умножение), / (деление нацело), % (остаток от деления). При использовании знака % в качестве знака операции в **командных файлах** он должен быть записан ДВАЖДЫ.

**Рекомендуется** при инициализации числовых переменных использовать ключ /A: `SET /A col=0`

## Ввод значения переменной с клавиатуры
Ввод значения переменной при выполнении командного файла выполняется командой SET с ключом /P. Например, для ввода значения переменной M следует использовать команду
`SET /P M=[введите M]`
Текст подсказки [введите М] будет выведен на экран.

## Оператор проверки условия IF
С помощью команды IF … ELSE (ключевое слово ELSE может отсутствовать) в пакетных файлах можно выполнять обработку условий нескольких типов.

## Проверка значения переменной

**`IF [NOT] ERRORLEVEL число команда`
  
`IF [NOT] строка1==строка2 команда`
  
`IF [NOT] EXIST имя_файла команда`
  
**Параметры:  
  
**NOT** - Указывает, что Windows должна выполнить эту команду, только если условие является ложным.  
  
**ERRORLEVEL число** - Условие является истинным, если код возврата последней выполненной программы не меньше указанного числа.  
  
**`строка1==строка2`** - Условие является истинным, если указанные строки совпадают.  
  
**EXIST имя_файла** - Условие является истинным, если файл с указанным именем существует.  
  
**команда** - Задает команду, выполняемую при истинности условия. За этой командой может следовать ключевое слово ELSE. В случае, если указанное условие ложно, будет выполнена команда, находящаяся после слова ELSE.

Изменение команды IF при включении расширенной обработки команд:  
  
**IF [/I] строка1 оператор_сравнения строка2 команда  
IF CMDEXTVERSION число команда  
IF DEFINED переменная команда  
  
**где **оператор_сравнения** принимает следующие значения:  
  
**EQU** - равно  
**NEQ** - не равно  
**LSS** - меньше  
**LEQ** - меньше или равно  
**GTR** - больше  
**GEQ** - больше или равно,  
  
а ключ **/I**, если он указан, задает сравнение текстовых строк без учета регистра. Ключ **/I** можно также использовать и в форме **`строка1==строка2`** команды IF. Сравнения проводятся по общему типу данных, так что если строки 1 и 2 содержат только цифры, то обе строки преобразуются в числа, после чего выполняется сравнение чисел.  
  
Условие CMDEXTVERSION применяется подобно условию ERRORLEVEL, но значение сравнивается с внутренним номером версии текущей реализации расширенной обработки команд. Первая версия имеет номер 1. Номер версии будет увеличиваться на единицу при каждом добавлении существенных возможностей расширенной обработки команд. Если расширенная обработка команд отключена, условие CMDEXTVERSION никогда не бывает истинно.  
  
Условие **DEFINED** применяется подобно условию **EXIST**, но принимает в качестве аргумента имя переменной среды и возвращает истинное значение, если эта переменная определена.  
  
Строка %ERRORLEVEL% будет развернута в строковое представление текущего значения кода ошибки ERRORLEVEL, за исключением ситуации, когда уже имеется переменная среды с именем ERRORLEVEL; в подобном случае подставляется значение этой переменной. Например, с помощью данной строки можно выполнить следующее:  
  
**goto answer%ERRORLEVEL%  
:answer0  
echo Получен код возврата 0  
:answer1  
echo Получен код возврата 1  
**

## Циклы for

Команда **FOR** используется для выполнения команды, заданной в виде параметра, для каждого элемента из набора. В качестве элементов могут использоваться файлы, каталоги, наборы строк.  
  
Формат командной строки:  
  
**FOR %переменная IN (набор) DO команда [параметры]**  
  
Параметры:  
  
**%переменная** - Однобуквенный подставляемый параметр.  
  
**(набор)** - Определяет набор, состоящий из одного или нескольких элементов, обрабатываемых командой.  
  
**команда** - Команда, которую следует выполнить для каждого элемента набора.  
  
**параметры** - Параметры для команды, выполняемой по отношению к элементам набора.  
  
. В пакетных файлах для команды FOR используется запись **`%%переменная`** вместо **`%переменная`**. Имена переменных учитывают регистр букв (%i отличается от %I).  
  
Поддерживаются также дополнительные форма команды FOR:  
  
**FOR /D %переменная IN (набор) DO команда [параметры]**  
  
Ключ /D задает в качестве набора имена каталогов (не файлов).  
  
**FOR /R [[диск:]путь] %переменная IN (набор) DO команда [параметры]**  
  
Ключ /R задает выполнение команды для каталога [диск:]путь, а также для всех подкаталогов этого пути. Если после ключа /R не указано имя каталога, используется текущий каталог. Если набор - это одиночный символ точки (.), команда просто перечисляет дерево каталогов.  
  
**FOR /L %переменная IN (начало,шаг,конец) DO команда [параметры]**  
  
Ключ /L задает обработку набора из последовательности чисел с заданными началом, концом и шагом приращения. Так, набор (1,1,5) раскрывается в (1 2 3 4 5), а набор (5,-1,1) - в (5 4 3 2 1)  
  
**FOR /F ["ключи"] %переменная IN (набор-файлов) DO команда [параметры]**  
  
**FOR /F ["ключи"] %переменная IN ("строка") DO команда [параметры]**  
  
**FOR /F ["ключи"] %переменная IN ('команда') DO команда [параметры]**  
  
Ключ /F задает обработку файлов, строковых значений или результатов стандартного вывода другой команды. Набор файлов - содержит имена одного или нескольких файлов, которые по очереди открываются, читаются и обрабатываются. Обработка состоит в чтении файла, разбивке его на отдельные строки текста и разборе каждой строки в ноль или более подстрок. Затем вызывается тело цикла "for", при выполнении которого каждая найденная подстрока используется в качестве значения переменной. По умолчанию ключ /F выделяет из каждой строки каждого файла первую отделенную пробелами подстроку. Пустые строки в файле пропускаются. Необязательный параметр "ключи" служит для переопределения правил разбора по умолчанию. Он представляет собой заключенную в кавычки строку, содержащую одно или несколько ключевых слов для определения параметров разбора. Ключевые слова:  
  
**eol=символ** - знак начала комментария в конце строки ( признак конца обрабатываемых данных строки). Задается в виде одиночного символа.  
  
**skip=n** - число пропускаемых при обработке строк от начала файла.  
  
**delims=xxx** - набор разделителей между обрабатываемыми элементами строк. По умолчанию, в качестве разделителей используются пробелы и знаки табуляции.  
  
**tokens=x,y,m-n** - номера подстрок из каждой строки, передаваемые в тело цикла "for" для каждой итерации. Например, для обычного текстового файла, подстроками будут слова, а разделителями подстрок - пробелы или знаки табуляции. При использовании этого ключа выделяются дополнительные имена переменных. Формат **m-n** представляет собой диапазон подстрок с номерами от m по n. Если последний знак в строке **tokens=** является звездочкой, то создается дополнительная переменная, значением которой будет весь оставшийся текст в строке после разбора последней подстроки.  
  
**usebackq** - режим обработки кавычек. Строка, заключенная в обратные кавычки, выполняется как команда, строка, заключенная в прямые одиночные кавычки, является строкой символов, а двойные кавычки могут использоваться для задания имен файлов, содержащих пробелы.  
  
Поясняющий пример:  
  
**FOR /F "eol=; tokens=2,3* delims=, " %i in (myfile.txt) do @echo %i %j %k**  
  
Выполняется разбор файла myfile.txt. Все строки, которые начинаются с символа точки с запятой (eol=; ), пропускаются. Вторая и третья подстроки из каждой строки ( tokens=2,3 ) передаются в тело цикла "for", причем подстроки разделяются запятыми и/или пробелами. В теле цикла переменная **%i** принимает значение второй подстроки, **%j** - третьей, а **%k** - все оставшееся поле до конца строки после третьей подстроки . Имена файлов, содержащие пробелы, необходимо заключать в двойные кавычки. Чтобы использовать двойные кавычки, необходимо использовать параметр usebackq, иначе двойные кавычки будут восприняты как определение строки-литерала для разбора.  
  
В данном примере переменная **%i** явно объявлена в инструкции "for", а переменные **%j** и **%k** объявляются неявно с помощью ключа **tokens=** . Ключ **tokens=** позволяет извлечь из одной строки файла до 26 подстрок. Следует помнить, что имена переменных FOR являются **однобуквенными**, с учетом регистра, поэтому одновременно не может быть активно более 52 переменных, задаваемых как явно, так и неявно.  
  
Команда **FOR /F** может также использоваться для обработки явно заданной строки, заключенной в одиночные кавычки и указанной в качестве параметра в скобках. Она будет разобрана так же, как одиночная строка, считанная из входного файла.  
  
В качестве обрабатываемого набора, также, может быть использован вывод ( выходные данные ) другой команды. В этом случае используется в качестве параметра в скобках **строка в обратных одиночных кавычках** . Эта строка передается для выполнения дочернему обработчику команд CMD.EXE, а вывод этой команды сохраняется в памяти и разбирается так, как если бы это был файл. Пример:  
  
**FOR /F "usebackq delims==" %i IN (`set`) DO @echo %i,**  
  
Выполняется команда **SET**, отображающая значения переменных среды и команда **FOR /F** выведет их перечень с использованием команды **echo**.